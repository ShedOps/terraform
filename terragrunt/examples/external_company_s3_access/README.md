## Terragrunt Based External Client Example

This terragrunt based example performs the following, 
based on a ficticious requirement to allow an external client, and specific IAM users
varying access to S3 buckets / folders:

* Creates 2 x S3 buckets and folders / bucket policies

* Creates 2 x ficticious IAM based users

* Creates associated IAM roles / policies / groups

* Creates 2 x External Company IDs (via SSM / Parameter Store)


### IAM Users created and access, to simulate varying requirements (based on policies, ref this for testing):

* int-user1 has FULL access (including list objects) to bucket dev-bucket-1/folder1 ONLY

* int-user1 has FULL access (including list objects) to bucket prod-bucket-1/folder1 ONLY

* int-user2 has FULL access (including list objects) to bucket dev-bucket-2/folder2 ONLY

* int-user2 has FULL access (including list objects) to bucket prod-bucket-2/folder2 ONLY

* dev-ext-company-1 has GetObject access (including list objects) to bucket dev-bucket-1/folder1
ONLY

* prod-ext-company-2 has GetObject access (including list objects) to bucket prod-bucket-2/folder2
ONLY

The following ExternalID secrets are created in System Manager Parameter Store (dependent on environment chosen: dev or prod):

* dev-ext-company -SecureString (random 12 digit number)

* prod-ext-company -SecureString (random 12 digit number)

### Walkthrough:

* (!) You obviously need an AWS Account and already have programmatical access via awscli (!)

* Install latest terragrunt version

* Install latest terraform version

* export AWS_DEFAULT_REGION=eu-west-1 (or your choice)

* export TF_VAR_env_file=dev (or prod)

* Specify "ext_account_id" in: environment/dev/global.tfvars (or prod) - this is the simulated ext client aws account id

* Change directory to "resources"

* Execute: terragrunt run-all plan

* If you are happy with the above, execute: terragrunt run-all apply

### Testing:

To test the solution:

* Create / Generate access keys for int-user1 and int-user2, run aws configure on an appropriate
workstation and use the keys generated to test each user individually

* For external company tests, assume the role created by specifying arn of the role (including
account_id) and external id, like this:

```aws sts assume-role --role-arn arn:aws:iam::<your_main_aws_account_id>:role/ext-company-1 --role-session-name ext-company-1 --external-id <your_client_random_generated_ext_id_from_ssm_param_store>```

Then export the appropriate environment variables in order for awscli to utilize the access generated by
the above assume role, finally test access to the s3 buckets as described in the policies above.
